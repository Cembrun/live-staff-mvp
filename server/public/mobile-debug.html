<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Mobile Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .test-section { background: white; padding: 20px; margin: 10px 0; border-radius: 10px; }
        button { padding: 15px 25px; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px; }
        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîß Mobile Debug Test</h1>
    
    <div class="test-section">
        <h3>1. Basic API Test</h3>
        <button onclick="testAPI()">Test API Connection</button>
        <div id="api-result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Login Test</h3>
        <input type="text" id="username" placeholder="Username" value="admin">
        <input type="password" id="password" placeholder="Password" value="admin123">
        <button onclick="testLogin()">Test Login</button>
        <button onclick="testTokenVerify()">Test Token Verify</button>
        <div id="login-result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Data Load Test</h3>
        <button onclick="testDataLoad()">Test Data Loading</button>
        <div id="data-result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Socket.IO Test</h3>
        <button onclick="testSocket()">Test Socket.IO</button>
        <div id="socket-result"></div>
    </div>
    
    <div class="test-section">
        <h3>5. LocalStorage Test</h3>
        <button onclick="testStorage()">Test LocalStorage</button>
        <div id="storage-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Console Log</h3>
        <div id="console-log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const API_BASE = window.location.origin + '/api';
        let socket = null;
        
        function log(message) {
            console.log(message);
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML += message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
        }
        
        // Override console.log to show in our log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML += args.join(' ') + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        async function testAPI() {
            log('üåê Testing API connection...');
            log('API_BASE: ' + API_BASE);
            
            try {
                const response = await fetch(API_BASE + '/test', {
                    method: 'GET',
                });
                log('API Response Status: ' + response.status);
                document.getElementById('api-result').innerHTML = `
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>OK:</strong> ${response.ok}
                `;
            } catch (error) {
                log('‚ùå API Error: ' + error.message);
                document.getElementById('api-result').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
        
        async function testLogin() {
            log('üîê Testing login...');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(API_BASE + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                log('Login Response Status: ' + response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Login successful');
                    log('Token: ' + data.token.substring(0, 20) + '...');
                    log('User: ' + JSON.stringify(data.user));
                    
                    localStorage.setItem('token', data.token);
                    document.getElementById('login-result').innerHTML = `
                        <strong>‚úÖ Success!</strong><br>
                        User: ${data.user.username}<br>
                        Role: ${data.user.role}<br>
                        Token saved to localStorage
                    `;
                } else {
                    const error = await response.text();
                    log('‚ùå Login failed: ' + error);
                    document.getElementById('login-result').innerHTML = `<strong>‚ùå Failed:</strong> ${error}`;
                }
            } catch (error) {
                log('üí• Login error: ' + error.message);
                document.getElementById('login-result').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
        
        async function testTokenVerify() {
            log('üîç Testing token verification...');
            const token = localStorage.getItem('token');
            log('Token from localStorage: ' + (token ? 'EXISTS' : 'NOT FOUND'));
            
            if (!token) {
                document.getElementById('login-result').innerHTML += '<br><strong>‚ùå No token found</strong>';
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/user-info', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('Token verify response: ' + response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Token valid');
                    log('User info: ' + JSON.stringify(data));
                    document.getElementById('login-result').innerHTML += `
                        <br><strong>‚úÖ Token Valid!</strong><br>
                        User: ${data.username}<br>
                        Role: ${data.role}
                    `;
                } else {
                    log('‚ùå Token invalid');
                    document.getElementById('login-result').innerHTML += '<br><strong>‚ùå Token Invalid</strong>';
                }
            } catch (error) {
                log('üí• Token verify error: ' + error.message);
                document.getElementById('login-result').innerHTML += `<br><strong>Error:</strong> ${error.message}`;
            }
        }
        
        async function testDataLoad() {
            log('üìä Testing data loading...');
            const token = localStorage.getItem('token');
            
            if (!token) {
                log('‚ùå No token for data loading');
                document.getElementById('data-result').innerHTML = '<strong>‚ùå No token</strong>';
                return;
            }
            
            try {
                const [employeesRes, deptsRes] = await Promise.all([
                    fetch(API_BASE + '/employees', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(API_BASE + '/departments', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                
                log('Employees response: ' + employeesRes.status);
                log('Departments response: ' + deptsRes.status);
                
                const employees = await employeesRes.json();
                const departments = await deptsRes.json();
                
                log('Employees loaded: ' + employees.length);
                log('Departments loaded: ' + departments.length);
                log('Employees data: ' + JSON.stringify(employees));
                log('Departments data: ' + JSON.stringify(departments));
                
                document.getElementById('data-result').innerHTML = `
                    <strong>‚úÖ Data Loaded!</strong><br>
                    Employees: ${employees.length}<br>
                    Departments: ${departments.length}<br>
                    <details>
                        <summary>Raw Data</summary>
                        <pre>${JSON.stringify({employees, departments}, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                log('üí• Data loading error: ' + error.message);
                document.getElementById('data-result').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
        
        async function testSocket() {
            log('üîå Testing Socket.IO...');
            const token = localStorage.getItem('token');
            
            try {
                socket = io(window.location.origin, { 
                    auth: { token: token }
                });
                
                socket.on('connect', () => {
                    log('‚úÖ Socket.IO connected');
                    document.getElementById('socket-result').innerHTML = '<strong>‚úÖ Connected!</strong>';
                });
                
                socket.on('state', (data) => {
                    log('üì© Socket.IO state received');
                    log('State data: ' + JSON.stringify(data));
                    document.getElementById('socket-result').innerHTML += `
                        <br><strong>üì© State Update:</strong><br>
                        Employees: ${data.employees?.length || 0}<br>
                        Departments: ${data.departments?.length || 0}
                    `;
                });
                
                socket.on('disconnect', (reason) => {
                    log('‚ùå Socket.IO disconnected: ' + reason);
                    document.getElementById('socket-result').innerHTML += '<br><strong>‚ùå Disconnected: ' + reason + '</strong>';
                });
                
                socket.on('connect_error', (error) => {
                    log('üí• Socket.IO error: ' + error.message);
                    document.getElementById('socket-result').innerHTML = '<strong>‚ùå Connection Error: ' + error.message + '</strong>';
                });
                
            } catch (error) {
                log('üí• Socket.IO setup error: ' + error.message);
                document.getElementById('socket-result').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
        
        function testStorage() {
            log('üíæ Testing localStorage...');
            
            // Test write
            localStorage.setItem('test-key', 'test-value');
            const testValue = localStorage.getItem('test-key');
            
            // Test token
            const token = localStorage.getItem('token');
            
            log('Test value: ' + testValue);
            log('Token exists: ' + !!token);
            
            document.getElementById('storage-result').innerHTML = `
                <strong>LocalStorage Test:</strong><br>
                Test write/read: ${testValue === 'test-value' ? '‚úÖ OK' : '‚ùå Failed'}<br>
                Token exists: ${token ? '‚úÖ Yes' : '‚ùå No'}<br>
                Token preview: ${token ? token.substring(0, 20) + '...' : 'None'}
            `;
            
            // Cleanup
            localStorage.removeItem('test-key');
        }
        
        // Initialize
        log('üöÄ Mobile Debug Test loaded');
        log('Current URL: ' + window.location.href);
        log('API_BASE: ' + API_BASE);
    </script>
</body>
</html>
